<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
  <script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous">
  </script>
  <title>TwittEarth</title>
  <style>
  *
  {
     font-family: "Calibri"
  }
    .tweet {
      border: 1px solid black;
      width: 25em;
      padding: 2em;
      margin-top: 2em;
    }

    .sentiment{
      border: 1px solid black;
      border-color: red;
      padding: 2em;
    }
  </style>
</head>
<body>
  <div><h1>TwittEarth</h1></div>
  <div class="row">
    <div class="col">
      <div id="radios">
        <input type="radio" id="radio_userTimeline" name="search" value="byUser" checked="checked">
        <label for="radio_userTimeline">Search User Timeline</label><br>
        <input type="radio" id="radio_textTweets" name="search" value="byText">
        <label for="radio_textTweets">Search Tweets with given Text</label><br>
        <input type="radio" id="radio_hashtagTweets" name="search" value="byHashtag">
        <label for="radio_hashtagTweets">Search Tweets with given Hashtag</label><br>
        <input type="radio" id="radio_location" name="search" value="byLocation">
        <label for="radio_location">Search Tweets of people living in a given Location</label><br>
        <hr>
        <input type="checkbox" id="check_geo" name="geocheck" value="geocheck">
        <label for="check_geo">Show only geolocalized Tweets</label>
        <input type="checkbox" id="check_sent" name="sentcheck" value="sentcheck" disabled>
        <label for="check_sent">Show sentiment for word searching tweets</label><br>
      </div>
      <div id= "searchDiv">
        <h3 id="searchhead">Inserisci il nome utente</h3>
        <form id="simpleform" action="javascript:userTimeline()">
          <input id="searchbar" type="text" placeholder="Nome utente..." name="searchbar" required="true">
          <button type="submit" id= "searchbutton"><i class="fa fa-search"></i></button>
        </form>
      </div>
      <div id= "base"></div>
    </div>
    <div class="col">
      <div id="map" style="width: 900px; height: 400px;"></div>
    </div>
  </div>
</body>
<script>

var only_geo = false;
var sent_analyze = false;
var mymap = L.map('map').setView([0, 0], 1);

//serverUrl = "http://localhost:8000/";
serverUrl = "https://site202136.tw.cs.unibo.it/";

function changebar(choice){
  return function(){
    $("#base").empty();
    if(choice == "user"){
        document.getElementById('searchbar').setAttribute('placeholder', "Nome utente ...");
        //.getElementById('searchbutton').setAttribute('onclick', "userTimeline()");
        document.getElementById('simpleform').setAttribute('action', "javascript:userTimeline()");
        document.getElementById('searchhead').innerHTML = "Inserisci il nome utente";
        document.getElementById('check_sent').disabled = true;
      } else if(choice == "text"){
        document.getElementById('searchbar').setAttribute('placeholder', "Testo ...");
        //document.getElementById('searchbutton').setAttribute('onclick', "textTweet()");
        document.getElementById('simpleform').setAttribute('action', "javascript:textTweet()");
        document.getElementById('searchhead').innerHTML = "Inserisci il testo da cercare";
        document.getElementById('check_sent').disabled = false;
      } else if(choice == "hashtag"){
        document.getElementById('searchbar').setAttribute('placeholder', "Hashtag ...");
        //document.getElementById('searchbutton').setAttribute('onclick', "hashtagTweet()");
        document.getElementById('simpleform').setAttribute('action', "javascript:hashtagTweet()");
        document.getElementById('searchhead').innerHTML = "Inserisci l'hashtag da cercare";
        document.getElementById('check_sent').disabled = true;
      } else if(choice == "location"){
        document.getElementById('searchbar').setAttribute('placeholder', "Località ...");
        //document.getElementById('searchbutton').setAttribute('onclick', "locationTweet()");
        document.getElementById('simpleform').setAttribute('action', "javascript:locationTweet()");
        document.getElementById('searchhead').innerHTML = "Inserisci il luogo da cercare";
        document.getElementById('check_sent').disabled = true;
      }
    }
}
window.onload = function(){
  BlankMap(mymap);
  only_geo= false;
  sent_analyze = false;
  var choice_user = document.getElementById('radio_userTimeline');
  var choice_text = document.getElementById('radio_textTweets');
  var choice_hashtag = document.getElementById('radio_hashtagTweets');
  var choice_location = document.getElementById('radio_location');
  choice_text.checked = false;
  choice_hashtag.checked = false;
  choice_location.checked = false;
  choice_user.checked = true;
  choice_user.addEventListener('click', changebar("user"), false);
  choice_text.addEventListener('click', changebar("text"), false);
  choice_hashtag.addEventListener('click', changebar("hashtag"), false);
  choice_location.addEventListener('click', changebar("location"), false);
  var choice_geo = document.getElementById('check_geo');
  var choice_sent = document.getElementById('check_sent');
  choice_sent.checked = false;
  choice_sent.disabled = true;
  choice_geo.checked = false;
  choice_geo.addEventListener('click', () => {only_geo= !only_geo;}, false);
  choice_sent.addEventListener('click', () => {sent_analyze = !sent_analyze}, false)
}

function userTimeline(){
  $("#base").empty();
  var user= document.getElementById('searchbar').value
  if (user[0]=='@') {
    user = user.substring(1);
  }
  var url = serverUrl + "users/" + user
  $.ajax({
    type: 'GET',
    url: url,
    crossDomain: true,
    success: function( data ) {
      if (data['tweets']){
        for (let tweet of data['tweets']){
          if((tweet['geo'] == null && !only_geo) || (tweet['geo'] != null)){
              let newT = $("<div>");
              newT.addClass("tweet");
              let id= $("<p>");
              id.text("Author: " + user);
              newT.append(id);
              let content = $("<p>");
              content.text("Text: " + tweet['Text']);
              newT.append(content)
              if (tweet['geo'] != null){
                  loc = tweet['geo']['Name'];
                  let place = $("<p>");
                  place.text("Location: " + loc);
                  newT.append(place);
                }
              $("#base").append(newT);
              $("#base").append("<br>");
          }
        }
      }
      else{
        let newT = $('<div>');
        let p = $('<p>');
        p.text("Utente non trovato");
        newT.append(p);
        $('#base').append('<br>');
        $('#base').append(newT);
      }
    },
    error: function( err ){
      let newT = $("<div>");
      let txt= $("<p>");
      txt.text("Error: " + "Utente non trovato");
      newT.append(txt);
      $("#base").append(newT);
      $("#base").append("<br>");
    }
  });
}



function hashtagTweet(){
  $("#base").empty();
  var tag = document.getElementById('searchbar').value;
  let err = new Boolean(false);
  if (tag.includes(' '))
  {
    err = true;
  }
  if (tag[0]=='#') {
    tag = tag.substring(1);
  }
  var url = serverUrl + "tags/" + tag;
  $.ajax({
    type: 'GET',
    url: url,
    crossDomain: true,
    success: function( data2 ) {
      for (let tweet of data2['data']){
        if((tweet['geo'] == null && !only_geo) || (tweet['geo'] != null)){
          let newT = $("<div>");
          newT.addClass("tweet");
          if (err == true)
          {
            newT.text(" Non un Hashtag");
            $("#base").append(newT);
            return;
          }
          let id= $("<p>");
          id.text("id: " + tweet['id'].toString());
          newT.append(id);
          let content = $("<p>");
          content.text("text: " + tweet['text']);
          newT.append(content)
          if (tweet['geo'] != null){
            let loc ='';
              $.ajax({
                type: 'GET',
                url: serverUrl + "place/" + tweet['geo']['place_id'],
                crossDomain: true,
                success: function( data ) {
                  loc = data['full_name'];
                  let place = $("<p>");
                  place.text("location: " + loc);
                  newT.append(place);
                }
              });
          }
          $("#base").append(newT);
          $("#base").append("<br>");
        }
      }
    }
  });
}


function textTweet(){
  $("#base").empty();
  var frase = document.getElementById('searchbar').value
  frase = frase.replace("#", "~");
  var url = serverUrl + "recents/" + frase + "?sentiment=" + sent_analyze;
  $.ajax({
    type: 'GET',
    url: url,
    crossDomain: true,
    success: function( data ) {
      if (data['analysis_data']['avg']!= null){
        let newS = $('<div>');
        let p= $('<p>');
        p.text("Il sentimento per questa stringa è: " + data['analysis_data']['avg']);
        newS.append(p);
        p= $('<p>');
        p.text("Le parole totali analizzate sono: " + data['analysis_data']['Tot_words']);
        newS.append(p);
        p= $('<p>');
        p.text("Le parole positive totali sono: " + data['analysis_data']['Tot_pos']);
        newS.append(p);
        p= $('<p>');
        p.text("Le parole negative totali sono: " + data['analysis_data']['Tot_neg']);
        newS.append(p);
        $('#base').append('<br>');
        $("#base").append(newS);
        $('#base').append('<br>');
      }
      for (let tweet of data['data']){
        if((tweet['geo'] == null && !only_geo) || (tweet['geo'] != null)){
        let newT = $("<div>");
        newT.addClass("tweet");
        let id= $("<p>");
        id.text("Author: " + tweet['Author']);
        newT.append(id);
        let content = $("<p>");
        content.text("Text: " + tweet['Text']);
        newT.append(content)
        let lang = $("<p>");
        lang.text("Language: " + tweet['Lang']);
        let newSent = $("<div>");
        newSent.addClass("sentiment");
        if (data['analysis_data']['avg']!= null){
          let p = $("<p>");
          p.text("Score: " + tweet['sentiment']['eval'][0]['Score']);
          newSent.append(p);
          p = $("<p>");
          p.text("Numero di parole positive: " + tweet['sentiment']['eval'][0]['PosL']);
          newSent.append(p);
          let t = ""
          for (let pos of tweet['sentiment']['eval'][0]['Pos']){
            t+= pos + ", "
          }
          p = $("<p>");
          p.text("Parole positive: " + t);
          newSent.append(p);
          p = $("<p>");
          p.text("Numero di parole negative: " + tweet['sentiment']['eval'][0]['NegL']);
          newSent.append(p);
          let tn = ""
          for (let pos of tweet['sentiment']['eval'][0]['Neg']){
            tn+= pos + ", "
          }
          p = $("<p>");
          p.text("Parole negative: " + tn);
          newSent.append(p);
          newT.append(newSent);
        }
        if (tweet['geo'] != null){
          let geo= $("<p>");
          geo.text("Location: " + tweet['geo']['Name']);
          newT.append(geo);
          }
        $("#base").append(newT);
        $("#base").append("<br>");
        }
      }
    }
  });
}

function locationTweet(){
  $("#base").empty();
  var location= document.getElementById('searchbar').value
  var url = serverUrl + "geo/" + location
  $.ajax({
    type: 'GET',
    url: url,
    crossDomain: true,
    success: function( data ) {
      for (let tweet of data['statuses']){
        if((tweet['place'] == null && !only_geo) || (tweet['place'] != null)){
          let newT = $("<div>");
          newT.addClass("tweet");
          let id= $("<p>");
          id.text("id: " + tweet['id'].toString());
          newT.append(id);
          let content = $("<p>");
          content.text("text: " + tweet['text']);
          newT.append(content)
          if (tweet['place'] != null){
            let place = $("<p>");
            place.text("location: " + tweet['place']['full_name']);
            newT.append(place);
          }
          $("#base").append(newT);
          $("#base").append("<br>");
        }
      }
    },
    error: function( err ){
      let newT = $("<div>");
      let txt= $("<p>");
      txt.text("Error: " + err.responseJSON.message);
      newT.append(txt);
      $("#base").append(newT);
      $("#base").append("<br>");
    }
  });
}

//Mappa
//Costruisce una mappa vuota
function BlankMap(mymap){
  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
  	maxZoom: 18,
		minZoom: 1,
  	attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
  		'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
  	id: 'mapbox/streets-v11',
  	tileSize: 512,
  	zoomOffset: -1
  }).addTo(mymap);
}




  </script>
</html>
